<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <script src="https://code.jquery.com/jquery-3.4.1.js"
        integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.6.2/bootstrap-slider.js"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.6.2/css/bootstrap-slider.css" />

    <title>&#10084; Desperation Quiz &#10084;</title>
    <style>
        .slider-handle {
            background: #2c3e50;
        }

        .slider-track,
        .slider-selection {
            background: #b4bcc2;
        }
    </style>
</head>

<body class="bg-info">
    <div class="container">

        <div class="jumbotron mt-5 bg-secondary">
            <h1 class="text-center">
                <p>&#10084; Desperation &#10084;</p>
            </h1>
            <hr>
            <h2 class="text-center text-white">Quiz &#128463;</i></h2>
            <br>
        </div>

        <div class="row">

            <div class="col-lg-12">

                <div class="card">

                    <div class="card-header bg-danger">
                        <h4>Name (Required)</h4>
                        <input id="name" class="form-control" type="text" required>
                        <h4>Link to Photo (Required)</h4>
                        <input id="pic" class="form-control" type="text" required>
                    </div>

                    <div class="card-body bg-secondary">

                        <div class="panel-body bg-secondary">
                            <div class="panel panel-primary" id="p1">
                                <div class="panel-body">

                                    <h3><strong>Question 1</strong></h3>
                                    <h4>You feel all alone, when you are all alone.</h4>
                                    <p>
                                        <input id="q1" data-slider-id='q1Slider' type="text" data-slider-min="1"
                                            data-slider-max="5" data-slider-step=".01" data-slider-value="3"
                                            style="width: 100%" />
                                    </p>
                                    <p>
                                        <h3 style="text-align: center" id="q1Result">Slide to Answer</h3>
                                    </p>
                                </div>
                            </div>
                            <hr>
                            <div class="panel panel-primary" id="p2">
                                <div class="panel-body">
                                    <h3><strong>Question 2</strong></h3>
                                    <h4>You enjoy shopping on black Friday.</h4>
                                    <p>
                                        <input id="q2" data-slider-id='q2Slider' type="text" data-slider-min="1"
                                            data-slider-max="5" data-slider-step=".01" data-slider-value="3"
                                            style="width: 100%" />
                                    </p>
                                    <p>
                                        <h3 style="text-align: center" id="q2Result">Slide to Answer</h3>
                                    </p>
                                </div>
                            </div>
                            <hr>
                            <div class="panel panel-primary" id="p3">
                                <div class="panel-body">
                                    <h3><strong>Question 3</strong></h3>
                                    <h4>You find the sound of Fran Drescher's voice soothing.</h4>
                                    <p>
                                        <input id="q3" data-slider-id='q3Slider' type="text" data-slider-min="1"
                                            data-slider-max="5" data-slider-step=".01" data-slider-value="3"
                                            style="width: 100%" />
                                    </p>
                                    <p>
                                        <h3 style="text-align: center" id="q3Result">Slide to Answer</h3>
                                    </p>
                                </div>
                            </div>
                            <hr>
                            <div class="panel panel-primary" id="p4">
                                <div class="panel-body">
                                    <h3><strong>Question 4</strong></h3>
                                    <h4>Peace and quiet doesn't bring you peace.</h4>
                                    <p>
                                        <input id="q4" data-slider-id='q4Slider' type="text" data-slider-min="1"
                                            data-slider-max="5" data-slider-step=".01" data-slider-value="3"
                                            style="width: 100%" />
                                    </p>
                                    <p>
                                        <h3 style="text-align: center" id="q4Result">Slide to Answer</h3>
                                    </p>
                                </div>
                            </div>
                            <hr>
                            <div class="panel panel-primary" id="p5">
                                <div class="panel-body">
                                    <h3><strong>Question 5</strong></h3>
                                    <h4>Any attention is good attention.</h4>
                                    <input id="q5" data-slider-id='q5Slider' type="text" data-slider-min="1"
                                        data-slider-max="5" data-slider-step=".01" data-slider-value="3"
                                        style="width: 100%" />
                                    </p>
                                    <p>
                                        <h3 style="text-align: center" id="q5Result">Slide to Answer</h3>
                                    </p>
                                </div>
                            </div>
                            <hr>
                            <div class="panel panel-primary" id="p6">
                                <div class="panel-body">
                                    <h3><strong>Question 6</strong></h3>
                                    <h4>When Air Supply "All Out Of Love" plays, you cry.</h4>
                                    <p>
                                        <input id="q6" data-slider-id='q6Slider' type="text" data-slider-min="1"
                                            data-slider-max="5" data-slider-step=".01" data-slider-value="3"
                                            style="width: 100%" />
                                    </p>
                                    <p>
                                        <h3 style="text-align: center" id="q6Result">Slide to Answer</h3>
                                    </p>
                                </div>
                            </div>
                            <hr>
                            <div class="panel panel-primary" id="p7">
                                <div class="panel-body">
                                    <h3><strong>Question 7</strong></h3>
                                    <h4>You surround yourself with cats because they will never leave you... if you keep
                                        the door
                                        closed.</h4>
                                    <p>
                                        <input id="q7" data-slider-id='q7Slider' type="text" data-slider-min="1"
                                            data-slider-max="5" data-slider-step=".01" data-slider-value="3"
                                            style="width: 100%" />
                                    </p>
                                    <p>
                                        <h3 style="text-align: center" id="q7Result">Slide to Answer</h3>
                                    </p>
                                </div>
                            </div>
                            <hr>
                            <div class="panel panel-primary" id="p8">
                                <div class="panel-body">
                                    <h3><strong>Question 8</strong></h3>
                                    <h4>You often wake up cudling a pillow instead of a significant other.</h4>
                                    <p>
                                        <input id="q8" data-slider-id='q8Slider' type="text" data-slider-min="1"
                                            data-slider-max="5" data-slider-step=".01" data-slider-value="3"
                                            style="width: 100%" />
                                    </p>
                                    <p>
                                        <h3 style="text-align: center" id="q8Result">Slide to Answer</h3>
                                    </p>
                                </div>
                            </div>
                            <hr>
                            <div class="panel panel-primary" id="p9">
                                <div class="panel-body">
                                    <h3><strong>Question 9</strong></h3>
                                    <h4>You assume everyone that talks to you is hitting on you.</h4>
                                    <p>
                                        <input id="q9" data-slider-id='q9Slider' type="text" data-slider-min="1"
                                            data-slider-max="5" data-slider-step=".01" data-slider-value="3"
                                            style="width: 100%"/>
                                    </p>
                                    <p>
                                        <h3 style="text-align: center" id="q9Result">Slide to Answer</h3>
                                    </p>
                                </div>
                            </div>
                            <hr>
                            <div class="panel panel-primary" id="p10">
                                <div class="panel-body">
                                    <h3><strong>Question 10</strong></h3>
                                    <h4>The thought of dying alone is the reason you took this quiz.</h4>
                                    <p>
                                        <input id="q10" data-slider-id='q10Slider' type="text" data-slider-min="1"
                                            data-slider-max="5" data-slider-step=".01" data-slider-value="3"
                                            style="width: 100%" />
                                    </p>
                                    <p>
                                        <h3 style="text-align: center" id="q10Result">Slide to Answer</h3>
                                    </p>
                                </div>
                            </div>
                            <hr>
                            <button id='submit' class="btn btn-dark btn-lg btn-block">Submit &#10084;</button>
                            <button id='reset' class="btn btn-primary btn-block">Reset &#10084;</button>
                            <h3 id="message" style="text-align: center"></h3>
                        </div>

                    </div>
                </div>
            </div>

            <!-- MODAL -->
            <div id="resultModal" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Almost as Desperate as</h4>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-xs-5">
                                    <img class="img-responsive" id="match-pic"
                                        src="https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909__340.png"
                                        alt="Your Best Friend">
                                </div>
                                <div class="col-xs-7">
                                    <center>
                                        <h2 id="match-name"></h2>
                                        <h3 id="match-stats"></h3>
                                    </center>
                                </div>
                            </div>


                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <footer class="footer">
            <div class="container text-center">
                <h3><a href="/" class="text-dark">Home</a> | <a href="/api/friends" target="_blank"
                        class="text-dark">Desperate people</a> | <a class="text-dark" target="_blank"
                        href="https://github.com/Kpressley86/FriendFinder">GitHub Repo</a></h3>
            </div>
        </footer>
</body>

<!-- JAVASCRIPT CODE -->
<script>
    const questionIds = []
    // SLIDERS VALUE //
    for (let i = 1; i < 11; i++) {
        let questionId = `#q${i}`
        questionIds.push(questionId)
        $(questionId).slider().on('change', (e) => {
            let resultDiv = $(questionId + 'Result')
            let value = roundVal(e.value.newValue)
            $(this).addClass('answered')
            sliderResult(value, (color, text, txtColor) => {
                $(`#p${i}`).css('border-color', color)
                resultDiv.css({
                    'background-color': color,
                    'color': txtColor
                })
                    .html(text)
            })
        })
    };
    $('#reset').hide()
    $('#reset').on('click', () => {
        $('body').scrollTop(0)
        location.reload(true)
    });

    // SLIDER COLOR //
    function sliderResult(value, callback) {
        var color;
        var text;
        var txtColor;
        switch (value) {
            case 1:
                color = "red"
                text = "Disagree Completely"
                txtColor = "#ffffff"
                break;
            case 2:
                color = "OrangeRed"
                text = "Kinda Disagree"
                txtColor = "#2c3e50"
                break;
            case 3:
                color = "#b4bcc2"
                text = "Don't Care"
                txtColor = "#2c3e50"
                break;
            case 4:
                color = "LightGreen"
                text = "Kinda Agree"
                txtColor = "#2c3e50"
                break;
            case 5:
                color = "green"
                text = "Absolutely Agree"
                txtColor = "#ffffff"
                break;
            default:
                return;
        }
        callback(color, text, txtColor)
    };
    // SLIDER COLOR WIDTH AND VALUE AREA //
    function roundVal(value) {
        if (value < 1.8) {
            value = 1
        } else if (value < 2.6) {
            value = 2
        } else if (value < 3.4) {
            value = 3
        } else if (value < 4.2) {
            value = 4
        } else {
            value = 5
        }
        return value;
    };

    // SUBMIT ON CLICK //
    $('#submit').on('click', () => {
        // shows reset button //
        if ($(this).hasClass("disabled")) {
            return;
        }
        event.preventDefault();
        const picUrl = $('#pic').val().trim()
        // check for answers //
        const unanswered = testAnswers();
        // check photo url //
        const isValidUrl = testUrl(picUrl);
        // display #message if "checks" fail //
        if (unanswered.length > 0) {
            $('#message').html("You didn't answer: " + unanswered.join(", "))
        } else if (!isValidUrl) {
            $('#message').html(picUrl + " is not a valid URL.<br>Please enter a valid URL")
        } else {
            $('#message').empty()
            // get slider values //
            let scores = questionIds.map(qId => {
                return $(qId).slider('getValue')
            });

            let answers = {
                name: $('#name').val().trim(),
                photo: picUrl,
                scores: scores
            }

            // SEND USER DATA //
            $.post('/api/friends', answers, (result) => {
                console.log(result)
                testImage(result[0].photo, (isValid) => {
                    if (isValid) {
                        $('#match-pic').attr('src', result[0].photo)
                    } else {
                        $('#match-pic').attr('src', 'https://mynewsla.com/wp-content/themes/fearless/images/missing-image-232x150.png')
                    }
                    
                    var percent = Math.round(((40 - result[1]) / 40) * 100)
                    
                    $('#match-name').html(result[0].name)
                    $('#match-stats').html(percent + "% Match")
                    $('#resultModal').modal('show')
                    
                    for (var i = 0; i < result[0].scores.length; i++) {
                        var questionNum = i + 1
                        var qPanel = $('#p' + questionNum)
                        var resultDiv = $('#q' + questionNum + 'Result')
                        var userAnswer = answers.scores[i]
                        var compare = ("<center><h3>Your Answer: " + userAnswer + "  |  \
                                    "  + result[0].name + "'s Answer: " + result[0].scores[i] + "</h3></center>")
                        resultDiv.css(
                            {
                                'background-color': '#2c3e50', 'color': '#ffffff'
                            }
                        ).html(compare)
                        qPanel.css('border-color', '#2c3e50')
                        $('#q' + questionNum).slider("disable")
                        $('#submit').addClass('disabled')
                        $('#reset').show()
                    }
                });
            });
        }
    });
    // TEST URL //
    function testUrl(url) {
        var isValid = false
        var regex = /((https?\:\/\/)|(www\.))(\S+)(\w{2,4})(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/g;
        if (url.match(regex)) {
            isValid = true;
        }
        return isValid
    };
    // CHECK QUIZ FOR ANSWERS //
    function testAnswers() {
        var unanswered = []
        if ($('#name').val() === "") {
            unanswered.push("Your Name")
        }
        if ($('#pic').val() === "") {
            unanswered.push("Your Photo")
        }
        for (var i = 1; i < 11; i++) {
            var question = $('#q' + i)
            if ((question.hasClass('answered'))) {
                unanswered.push("Question #" + i)
            }
        }
        return unanswered;
    };
    // helper function to validate the image
    function testImage(imgUrl, callback) {
        var timedOut = false;
        var timer;
        var img = new Image();
        img.onerror = () => {
            if (!timedOut) {
                clearTimeout(timer);
                callback(false);
            }
        };
        img.onabort = () => {
            if (!timedOut) {
                clearTimeout(timer);
                callback(false);
            }
        };
        img.onload = () => {
            if (!timedOut) {
                clearTimeout(timer);
                callback(true);
            }
        };
        img.src = imgUrl
        timer = setTimeout(() => {
            timedOut = true;
            callback(false)
        }, 5000);
    };
</script>

</html>